# .circleci/config.yml

version: 2
jobs:
  build:
    machine:
      image: circleci/classic:latest
      environment:
          ENV: CI
    steps:
      - checkout
      - run:
          name: "Build And Push"
          command: |
            docker build -f Sevices/AVT.Agents.Services/Dockerfile -t $DKR_IMG Sevices/AVT.Agents.Services
            docker login -u $DKR_UID -p $DKR_PWD  
            docker tag $DKR_IMG $DKR_REGITRY/$DKR_IMG:latest
            docker push $DKR_REGITRY/$DKR_IMG:latest
      - run:
          name: Save image to an archive
          command: |
            mkdir docker-image
            docker save -o docker-image/image.tar $DKR_IMG
      - persist_to_workspace:
          root: .
          paths:
            - docker-image
  deploy:
    docker:
      - image: circleci/python:3.6.1
    environment:
      AWS_DEFAULT_OUTPUT: json
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: workspace
      - run:
         name: "Prepare Environment"
         command: |
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"        
            unzip awscli-bundle.zip 
            ./awscli-bundle/install -b ~/bin/aws
            export PATH=~/bin:$PATH
            curl -O https://bootstrap.pypa.io/get-pip.py
            python get-pip.py
            pip install --upgrade pip
            pip install --upgrade awscli
            echo "*** preconfiguring environment ... ***"    
            aws configure set aws_access_key_id $AWS_KEY
            aws configure set aws_secret_access_key $AWS_SECRET
            aws configure set default.region eu-west-1
      - run:
          name: Load image from local file
          command: |
            docker load --input workspace/docker-image/image.tar
      - run:
          name: Push image to ECR
          command: |
            $(aws ecr get-login --region eu-west-1 --no-include-email)
            docker tag $DKR_IMG 166778461577.dkr.ecr.eu-west-1.amazonaws.com/$DKR_IMG:latest
            docker push 166778461577.dkr.ecr.eu-west-1.amazonaws.com/$DKR_IMG:latest
      - run:
          name: Deploy Scheduler to ECS
          command: |
            ./deployement.sh $ECS_TASK_SHCEDULER $ECS_SERVICE_SHCEDULER scheduler
      - run:
          name: Deploy Simulator to ECS
          command: |
            ./deployement.sh $ECS_TASK_SIMULATOR $ECS_SERVICE_SIMULATOR simulator
workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master